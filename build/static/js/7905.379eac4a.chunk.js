"use strict";(self.webpackChunkdefi_exchange_platform=self.webpackChunkdefi_exchange_platform||[]).push([[7905],{77905:(o,e,n)=>{n.d(e,{GN:()=>N});var t=n(89379),a=n(30574),r=n(76844),s=n(18833),i=n(80883),c=n(59979),d=n(86609),l=n(60205),u=n(84657),T=n(24657),k=n(13801);const v={getGasPriceInEther:(o,e)=>Number(e*o)/1e18,getGasPriceInUSD(o,e,n){const t=v.getGasPriceInEther(e,n);return s.S.bigNumber(o).times(t).toNumber()},getPriceImpact(o){let{sourceTokenAmount:e,sourceTokenPriceInUSD:n,toTokenPriceInUSD:t,toTokenAmount:a}=o;const r=s.S.bigNumber(e).times(n),i=s.S.bigNumber(a).times(t);return r.minus(i).div(r).times(100).toNumber()},getMaxSlippage(o,e){const n=s.S.bigNumber(o).div(100);return s.S.multiply(e,n).toNumber()},getProviderFee(o){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.0085;return s.S.bigNumber(o).times(e).toString()},isInsufficientNetworkTokenForGas(o,e){const n=e||"0";return!!s.S.bigNumber(o).eq(0)||s.S.bigNumber(s.S.bigNumber(n)).gt(o)},isInsufficientSourceTokenForSwap(o,e,n){var t;const a=null===n||void 0===n||null===(t=n.find(o=>o.address===e))||void 0===t||null===(t=t.quantity)||void 0===t?void 0:t.numeric;return s.S.bigNumber(a||"0").lt(o)}};var m=n(68882),g=n(63542),p=n(65618),w=n(17321),A=n(23743),S=n(25015),P=n(79323),f=n(61139),h=n(7258);const I=15e4;Error;const y={initializing:!1,initialized:!1,loadingPrices:!1,loadingQuote:!1,loadingApprovalTransaction:!1,loadingBuildTransaction:!1,loadingTransaction:!1,switchingTokens:!1,fetchError:!1,approvalTransaction:void 0,swapTransaction:void 0,transactionError:void 0,sourceToken:void 0,sourceTokenAmount:"",sourceTokenPriceInUSD:0,toToken:void 0,toTokenAmount:"",toTokenPriceInUSD:0,networkPrice:"0",networkBalanceInUSD:"0",networkTokenSymbol:"",inputError:void 0,slippage:u.oU.CONVERT_SLIPPAGE_TOLERANCE,tokens:void 0,popularTokens:void 0,suggestedTokens:void 0,foundTokens:void 0,myTokensWithBalance:void 0,tokensPriceMap:{},gasFee:"0",gasPriceInUSD:0,priceImpact:void 0,maxSlippage:void 0,providerFee:void 0},b=(0,a.BX)((0,t.A)({},y)),E={state:b,subscribe:o=>(0,a.B1)(b,()=>o(b)),subscribeKey:(o,e)=>(0,r.u$)(b,o,e),getParams(){var o,e,n,t,a,r,c,d,u,k;const v=w.W.state.activeChain,m=null!==(o=null===(e=w.W.getAccountData(v))||void 0===e?void 0:e.caipAddress)&&void 0!==o?o:w.W.state.activeCaipAddress,g=T.w.getPlainAddress(m),p=(0,l.K1)(),A=S.a.getConnectorId(w.W.state.activeChain);if(!g)throw new Error("No address found to swap the tokens from.");const P=!(null!==(n=b.toToken)&&void 0!==n&&n.address)||!(null!==(t=b.toToken)&&void 0!==t&&t.decimals),f=!(null!==(a=b.sourceToken)&&void 0!==a&&a.address)||!(null!==(r=b.sourceToken)&&void 0!==r&&r.decimals)||!s.S.bigNumber(b.sourceTokenAmount).gt(0),h=!b.sourceTokenAmount;return{networkAddress:p,fromAddress:g,fromCaipAddress:m,sourceTokenAddress:null===(c=b.sourceToken)||void 0===c?void 0:c.address,toTokenAddress:null===(d=b.toToken)||void 0===d?void 0:d.address,toTokenAmount:b.toTokenAmount,toTokenDecimals:null===(u=b.toToken)||void 0===u?void 0:u.decimals,sourceTokenAmount:b.sourceTokenAmount,sourceTokenDecimals:null===(k=b.sourceToken)||void 0===k?void 0:k.decimals,invalidToToken:P,invalidSourceToken:f,invalidSourceTokenAmount:h,availableToSwap:m&&!P&&!f&&!h,isAuthConnector:A===i.o.CONNECTOR_ID.AUTH}},async setSourceToken(o){if(!o)return b.sourceToken=o,b.sourceTokenAmount="",void(b.sourceTokenPriceInUSD=0);b.sourceToken=o,await N.setTokenPrice(o.address,"sourceToken")},setSourceTokenAmount(o){b.sourceTokenAmount=o},async setToToken(o){if(!o)return b.toToken=o,b.toTokenAmount="",void(b.toTokenPriceInUSD=0);b.toToken=o,await N.setTokenPrice(o.address,"toToken")},setToTokenAmount(o){b.toTokenAmount=o?s.S.toFixed(o,6):""},async setTokenPrice(o,e){let n=b.tokensPriceMap[o]||0;n||(b.loadingPrices=!0,n=await N.getAddressPrice(o)),"sourceToken"===e?b.sourceTokenPriceInUSD=n:"toToken"===e&&(b.toTokenPriceInUSD=n),b.loadingPrices&&(b.loadingPrices=!1),N.getParams().availableToSwap&&!b.switchingTokens&&N.swapTokens()},async switchTokens(){if(!b.initializing&&b.initialized&&!b.switchingTokens){b.switchingTokens=!0;try{const o=b.toToken?(0,t.A)({},b.toToken):void 0,e=b.sourceToken?(0,t.A)({},b.sourceToken):void 0,n=o&&""===b.toTokenAmount?"1":b.toTokenAmount;N.setSourceTokenAmount(n),N.setToTokenAmount(""),await N.setSourceToken(o),await N.setToToken(e),b.switchingTokens=!1,N.swapTokens()}catch(o){throw b.switchingTokens=!1,o}}},resetState(){b.myTokensWithBalance=y.myTokensWithBalance,b.tokensPriceMap=y.tokensPriceMap,b.initialized=y.initialized,b.initializing=y.initializing,b.switchingTokens=y.switchingTokens,b.sourceToken=y.sourceToken,b.sourceTokenAmount=y.sourceTokenAmount,b.sourceTokenPriceInUSD=y.sourceTokenPriceInUSD,b.toToken=y.toToken,b.toTokenAmount=y.toTokenAmount,b.toTokenPriceInUSD=y.toTokenPriceInUSD,b.networkPrice=y.networkPrice,b.networkTokenSymbol=y.networkTokenSymbol,b.networkBalanceInUSD=y.networkBalanceInUSD,b.inputError=y.inputError},resetValues(){var o;const{networkAddress:e}=N.getParams(),n=null===(o=b.tokens)||void 0===o?void 0:o.find(o=>o.address===e);N.setSourceToken(n),N.setToToken(void 0)},getApprovalLoadingState:()=>b.loadingApprovalTransaction,clearError(){b.transactionError=void 0},async initializeState(){if(!b.initializing){if(b.initializing=!0,!b.initialized)try{await N.fetchTokens(),b.initialized=!0}catch(o){b.initialized=!1,h.P.showError("Failed to initialize swap"),f.I.goBack()}b.initializing=!1}},async fetchTokens(){var o;const{networkAddress:e}=N.getParams();await N.getNetworkTokenPrice(),await N.getMyTokensWithBalance();const n=null===(o=b.myTokensWithBalance)||void 0===o?void 0:o.find(o=>o.address===e);n&&(b.networkTokenSymbol=n.symbol,N.setSourceToken(n),N.setSourceTokenAmount("0"))},async getTokenList(){var o;const e=null===(o=w.W.state.activeCaipNetwork)||void 0===o?void 0:o.caipNetworkId;if(b.caipNetworkId!==e||!b.tokens)try{var n;b.tokensLoading=!0;const o=await k.s.getTokenList(e);b.tokens=o,b.caipNetworkId=e,b.popularTokens=o.sort((o,e)=>o.symbol<e.symbol?-1:o.symbol>e.symbol?1:0);const t=(e&&(null===(n=u.oU.SUGGESTED_TOKENS_BY_CHAIN)||void 0===n?void 0:n[e])||[]).map(e=>o.find(o=>o.symbol===e)).filter(o=>Boolean(o)),a=(u.oU.SWAP_SUGGESTED_TOKENS||[]).map(e=>o.find(o=>o.symbol===e)).filter(o=>Boolean(o)).filter(o=>!t.some(e=>e.address===o.address));b.suggestedTokens=[...t,...a]}catch(t){b.tokens=[],b.popularTokens=[],b.suggestedTokens=[]}finally{b.tokensLoading=!1}},async getAddressPrice(o){var e,n;const t=b.tokensPriceMap[o];if(t)return t;const a=await p.T.fetchTokenPrice({addresses:[o]}),r=(null===a||void 0===a?void 0:a.fungibles)||[],s=[...b.tokens||[],...b.myTokensWithBalance||[]],i=null===s||void 0===s||null===(e=s.find(e=>e.address===o))||void 0===e?void 0:e.symbol,c=(null===(n=r.find(o=>o.symbol.toLowerCase()===(null===i||void 0===i?void 0:i.toLowerCase())))||void 0===n?void 0:n.price)||0,d=parseFloat(c.toString());return b.tokensPriceMap[o]=d,d},async getNetworkTokenPrice(){var o;const{networkAddress:e}=N.getParams(),n=null===(o=(await p.T.fetchTokenPrice({addresses:[e]}).catch(()=>(h.P.showError("Failed to fetch network token price"),{fungibles:[]}))).fungibles)||void 0===o?void 0:o[0],t=(null===n||void 0===n?void 0:n.price.toString())||"0";b.tokensPriceMap[e]=parseFloat(t),b.networkTokenSymbol=(null===n||void 0===n?void 0:n.symbol)||"",b.networkPrice=t},async getMyTokensWithBalance(o){const e=await d.Z.getMyTokensWithBalance(o),n=k.s.mapBalancesToSwapTokens(e);n&&(await N.getInitialGasPrice(),N.setBalances(n))},setBalances(o){const{networkAddress:e}=N.getParams(),n=w.W.state.activeCaipNetwork;if(!n)return;const t=o.find(o=>o.address===e);o.forEach(o=>{b.tokensPriceMap[o.address]=o.price||0}),b.myTokensWithBalance=o.filter(o=>o.address.startsWith(n.caipNetworkId)),b.networkBalanceInUSD=t?s.S.multiply(t.quantity.numeric,t.price).toString():"0"},async getInitialGasPrice(){var o,e,n;const t=await k.s.fetchGasPrice();if(!t)return{gasPrice:null,gasPriceInUSD:null};switch(null===(o=w.W.state)||void 0===o||null===(o=o.activeCaipNetwork)||void 0===o?void 0:o.chainNamespace){case i.o.CHAIN.SOLANA:return b.gasFee=null!==(e=t.standard)&&void 0!==e?e:"0",b.gasPriceInUSD=s.S.multiply(t.standard,b.networkPrice).div(1e9).toNumber(),{gasPrice:BigInt(b.gasFee),gasPriceInUSD:Number(b.gasPriceInUSD)};case i.o.CHAIN.EVM:default:const o=null!==(n=t.standard)&&void 0!==n?n:"0",a=BigInt(o),r=BigInt(I),c=v.getGasPriceInUSD(b.networkPrice,r,a);return b.gasFee=o,b.gasPriceInUSD=c,{gasPrice:a,gasPriceInUSD:c}}},async swapTokens(){var o;const e=null===(o=w.W.getAccountData())||void 0===o?void 0:o.address,n=b.sourceToken,t=b.toToken,a=s.S.bigNumber(b.sourceTokenAmount).gt(0);if(a||N.setToTokenAmount(""),!t||!n||b.loadingPrices||!a||!e)return;b.loadingQuote=!0;const r=s.S.bigNumber(b.sourceTokenAmount).times(10**n.decimals).round(0);try{var i;const o=await p.T.fetchSwapQuote({userAddress:e,from:n.address,to:t.address,gasPrice:b.gasFee,amount:r.toString()});b.loadingQuote=!1;const a=null===o||void 0===o||null===(i=o.quotes)||void 0===i||null===(i=i[0])||void 0===i?void 0:i.toAmount;if(!a)return void g.h.open({displayMessage:"Incorrect amount",debugMessage:"Please enter a valid amount"},"error");const c=s.S.bigNumber(a).div(10**t.decimals).toString();N.setToTokenAmount(c);N.hasInsufficientToken(b.sourceTokenAmount,n.address)?b.inputError="Insufficient balance":(b.inputError=void 0,N.setTransactionDetails())}catch(c){const o=await k.s.handleSwapError(c);b.loadingQuote=!1,b.inputError=o||"Insufficient balance"}},async getTransaction(){const{fromCaipAddress:o,availableToSwap:e}=N.getParams(),n=b.sourceToken,t=b.toToken;if(o&&e&&n&&t&&!b.loadingQuote)try{b.loadingBuildTransaction=!0;let e;return e=await k.s.fetchSwapAllowance({userAddress:o,tokenAddress:n.address,sourceTokenAmount:b.sourceTokenAmount,sourceTokenDecimals:n.decimals})?await N.createSwapTransaction():await N.createAllowanceTransaction(),b.loadingBuildTransaction=!1,b.fetchError=!1,e}catch(a){return f.I.goBack(),h.P.showError("Failed to check allowance"),b.loadingBuildTransaction=!1,b.approvalTransaction=void 0,b.swapTransaction=void 0,void(b.fetchError=!0)}},async createAllowanceTransaction(){const{fromCaipAddress:o,sourceTokenAddress:e,toTokenAddress:n}=N.getParams();if(o&&n){if(!e)throw new Error("createAllowanceTransaction - No source token address found.");try{const t=await p.T.generateApproveCalldata({from:e,to:n,userAddress:o}),a=T.w.getPlainAddress(t.tx.from);if(!a)throw new Error("SwapController:createAllowanceTransaction - address is required");const r={data:t.tx.data,to:a,gasPrice:BigInt(t.tx.eip155.gasPrice),value:BigInt(t.tx.value),toAmount:b.toTokenAmount};return b.swapTransaction=void 0,b.approvalTransaction={data:r.data,to:r.to,gasPrice:r.gasPrice,value:r.value,toAmount:r.toAmount},{data:r.data,to:r.to,gasPrice:r.gasPrice,value:r.value,toAmount:r.toAmount}}catch(t){return f.I.goBack(),h.P.showError("Failed to create approval transaction"),b.approvalTransaction=void 0,b.swapTransaction=void 0,void(b.fetchError=!0)}}},async createSwapTransaction(){var o;const{networkAddress:e,fromCaipAddress:n,sourceTokenAmount:t}=N.getParams(),a=b.sourceToken,r=b.toToken;if(!n||!t||!a||!r)return;const s=null===(o=A.x.parseUnits(t,a.decimals))||void 0===o?void 0:o.toString();try{const o=await p.T.generateSwapCalldata({userAddress:n,from:a.address,to:r.address,amount:s,disableEstimate:!0}),t=a.address===e,i=BigInt(o.tx.eip155.gas),c=BigInt(o.tx.eip155.gasPrice),d=T.w.getPlainAddress(o.tx.to);if(!d)throw new Error("SwapController:createSwapTransaction - address is required");const l={data:o.tx.data,to:d,gas:i,gasPrice:c,value:t?BigInt(null!==s&&void 0!==s?s:"0"):BigInt("0"),toAmount:b.toTokenAmount};return b.gasPriceInUSD=v.getGasPriceInUSD(b.networkPrice,i,c),b.approvalTransaction=void 0,b.swapTransaction=l,l}catch(i){return f.I.goBack(),h.P.showError("Failed to create transaction"),b.approvalTransaction=void 0,b.swapTransaction=void 0,void(b.fetchError=!0)}},onEmbeddedWalletApprovalSuccess(){h.P.showLoading("Approve limit increase in your wallet"),f.I.replace("SwapPreview")},async sendTransactionForApproval(o){const{fromAddress:e,isAuthConnector:n}=N.getParams();b.loadingApprovalTransaction=!0;n?f.I.pushTransactionStack({onSuccess:N.onEmbeddedWalletApprovalSuccess}):h.P.showLoading("Approve limit increase in your wallet");try{await A.x.sendTransaction({address:e,to:o.to,data:o.data,value:o.value,chainNamespace:i.o.CHAIN.EVM}),await N.swapTokens(),await N.getTransaction(),b.approvalTransaction=void 0,b.loadingApprovalTransaction=!1}catch(s){var t,a,r;const o=s;b.transactionError=null===o||void 0===o?void 0:o.displayMessage,b.loadingApprovalTransaction=!1,h.P.showError((null===o||void 0===o?void 0:o.displayMessage)||"Transaction error"),P.E.sendEvent({type:"track",event:"SWAP_APPROVAL_ERROR",properties:{message:(null===o||void 0===o?void 0:o.displayMessage)||(null===o||void 0===o?void 0:o.message)||"Unknown",network:(null===(t=w.W.state.activeCaipNetwork)||void 0===t?void 0:t.caipNetworkId)||"",swapFromToken:(null===(a=N.state.sourceToken)||void 0===a?void 0:a.symbol)||"",swapToToken:(null===(r=N.state.toToken)||void 0===r?void 0:r.symbol)||"",swapFromAmount:N.state.sourceTokenAmount||"",swapToAmount:N.state.toTokenAmount||"",isSmartAccount:(0,l.lj)(i.o.CHAIN.EVM)===c.Vl.ACCOUNT_TYPES.SMART_ACCOUNT}})}},async sendTransactionForSwap(o){var e,n,t,a;if(!o)return;const{fromAddress:r,toTokenAmount:d,isAuthConnector:u}=N.getParams();b.loadingTransaction=!0;const T="Swapping ".concat(null===(e=b.sourceToken)||void 0===e?void 0:e.symbol," to ").concat(s.S.formatNumberToLocalString(d,3)," ").concat(null===(n=b.toToken)||void 0===n?void 0:n.symbol),k="Swapped ".concat(null===(t=b.sourceToken)||void 0===t?void 0:t.symbol," to ").concat(s.S.formatNumberToLocalString(d,3)," ").concat(null===(a=b.toToken)||void 0===a?void 0:a.symbol);u?f.I.pushTransactionStack({onSuccess(){f.I.replace("Account"),h.P.showLoading(T),E.resetState()}}):h.P.showLoading("Confirm transaction in your wallet");try{var v,m,g,p,S;const e=[null===(v=b.sourceToken)||void 0===v?void 0:v.address,null===(m=b.toToken)||void 0===m?void 0:m.address].join(","),n=await A.x.sendTransaction({address:r,to:o.to,data:o.data,value:o.value,chainNamespace:i.o.CHAIN.EVM});return b.loadingTransaction=!1,h.P.showSuccess(k),P.E.sendEvent({type:"track",event:"SWAP_SUCCESS",properties:{network:(null===(g=w.W.state.activeCaipNetwork)||void 0===g?void 0:g.caipNetworkId)||"",swapFromToken:(null===(p=N.state.sourceToken)||void 0===p?void 0:p.symbol)||"",swapToToken:(null===(S=N.state.toToken)||void 0===S?void 0:S.symbol)||"",swapFromAmount:N.state.sourceTokenAmount||"",swapToAmount:N.state.toTokenAmount||"",isSmartAccount:(0,l.lj)(i.o.CHAIN.EVM)===c.Vl.ACCOUNT_TYPES.SMART_ACCOUNT}}),E.resetState(),u||f.I.replace("Account"),E.getMyTokensWithBalance(e),n}catch(U){var I,y,C;const o=U;return b.transactionError=null===o||void 0===o?void 0:o.displayMessage,b.loadingTransaction=!1,h.P.showError((null===o||void 0===o?void 0:o.displayMessage)||"Transaction error"),void P.E.sendEvent({type:"track",event:"SWAP_ERROR",properties:{message:(null===o||void 0===o?void 0:o.displayMessage)||(null===o||void 0===o?void 0:o.message)||"Unknown",network:(null===(I=w.W.state.activeCaipNetwork)||void 0===I?void 0:I.caipNetworkId)||"",swapFromToken:(null===(y=N.state.sourceToken)||void 0===y?void 0:y.symbol)||"",swapToToken:(null===(C=N.state.toToken)||void 0===C?void 0:C.symbol)||"",swapFromAmount:N.state.sourceTokenAmount||"",swapToAmount:N.state.toTokenAmount||"",isSmartAccount:(0,l.lj)(i.o.CHAIN.EVM)===c.Vl.ACCOUNT_TYPES.SMART_ACCOUNT}})}},hasInsufficientToken:(o,e)=>v.isInsufficientSourceTokenForSwap(o,e,b.myTokensWithBalance),setTransactionDetails(){const{toTokenAddress:o,toTokenDecimals:e}=N.getParams();o&&e&&(b.gasPriceInUSD=v.getGasPriceInUSD(b.networkPrice,BigInt(b.gasFee),BigInt(I)),b.priceImpact=v.getPriceImpact({sourceTokenAmount:b.sourceTokenAmount,sourceTokenPriceInUSD:b.sourceTokenPriceInUSD,toTokenPriceInUSD:b.toTokenPriceInUSD,toTokenAmount:b.toTokenAmount}),b.maxSlippage=v.getMaxSlippage(b.slippage,b.toTokenAmount),b.providerFee=v.getProviderFee(b.sourceTokenAmount))}},N=(0,m.X)(E)}}]);
//# sourceMappingURL=7905.379eac4a.chunk.js.map